name: PR Guardrails

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  guardrails:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure PR description has required sections
        uses: actions/github-script@v7
        with:
          script: |
            const body = (context.payload.pull_request.body || "").toLowerCase();

            const requiredSections = ["## task plan", "## tests"];
            const missing = requiredSections.filter(s => !body.includes(s.toLowerCase()));

            if (missing.length > 0) {
              core.setFailed(
                `PR description is missing required section(s): ${missing.join(", ")}. ` +
                `Please use the PR template (Task Plan + Tests).`
              );
            }

            // If PR has 'frontend' label, enforce screenshots section
            const labels = context.payload.pull_request.labels.map(l => l.name.toLowerCase());
            const isFrontend = labels.includes("frontend");

            if (isFrontend) {
              const hasScreenshotsSection = body.includes("## screenshots");
              if (!hasScreenshotsSection) {
                core.setFailed(
                  "This PR is labeled 'frontend' but is missing the '## Screenshots' section."
                );
              }
            }

      - name: Compute PR size and enforce max changed lines
        id: size
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1

          # Get stats between PR base and head
          STATS=$(git diff --shortstat origin/${{ github.base_ref }}...${{ github.sha }})
          echo "Diff stats: $STATS"

          ADDED=$(echo "$STATS" | sed -n 's/.* \([0-9]\+\) insertions.*/\1/p')
          DELETED=$(echo "$STATS" | sed -n 's/.* \([0-9]\+\) deletions.*/\1/p')

          ADDED=${ADDED:-0}
          DELETED=${DELETED:-0}
          TOTAL=$((ADDED + DELETED))

          echo "Added: $ADDED, Deleted: $DELETED, Total changed: $TOTAL"

          MAX_LINES=300

          echo "total_changed_lines=$TOTAL" >> $GITHUB_OUTPUT

          if [ "$TOTAL" -gt "$MAX_LINES" ]; then
            echo "PR too large: $TOTAL lines changed (limit is $MAX_LINES)."
            echo "Please split into smaller PRs or add the 'large-pr-ok' label."
            exit 1
          fi

      - name: Allow override for large PRs with label
        if: failure() && steps.size.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name.toLowerCase());
            if (labels.includes("large-pr-ok")) {
              core.notice("Large PR allowed because it has the 'large-pr-ok' label.");
              // Mark job as success despite previous failure
              core.exportVariable('BYPASS_LARGE_PR', 'true');
            } else {
              core.setFailed("Large PR without 'large-pr-ok' label.");
            }

      - name: Fail if large PR without override
        if: env.BYPASS_LARGE_PR != 'true' && steps.size.outcome == 'failure'
        run: |
          echo "Large PR check failed and no override label present."
          exit 1

      - name: Enforce no console.log / debugger in changed files
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1

          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} | grep -E '\.(js|jsx|ts|tsx)$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No JS/TS files changed."
            exit 0
          fi

          echo "Changed JS/TS files:"
          echo "$CHANGED_FILES"

          # Look for console.log or debugger in changed files
          VIOLATIONS=$(echo "$CHANGED_FILES" | xargs grep -nE 'console\.log|debugger' || true)

          if [ -n "$VIOLATIONS" ]; then
            echo "❌ Found console.log/debugger in the following locations:"
            echo "$VIOLATIONS"
            exit 1
          fi

          echo "✅ No console.log/debugger found in changed files."

      - name: Enforce tests were touched (with optional escape hatch)
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1

          # If PR has label 'no-tests-needed', skip this check
          LABELS=$(jq -r '.pull_request.labels[].name' <<< '${{ toJson(github.event) }}' || true)
          if echo "$LABELS" | tr '[:upper:]' '[:lower:]' | grep -q 'no-tests-needed'; then
            echo "Skipping 'tests touched' check due to 'no-tests-needed' label."
            exit 0
          fi

          CHANGED_TEST_FILES=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} | grep -E '(__tests__/|\.test\.(js|jsx|ts|tsx)|\.spec\.(js|jsx|ts|tsx))' || true)

          if [ -z "$CHANGED_TEST_FILES" ]; then
            echo "❌ No test files modified. If this PR truly does not need tests, add the 'no-tests-needed' label and explain why in the PR."
            exit 1
          fi

          echo "✅ Test files modified:"
          echo "$CHANGED_TEST_FILES"
